import os
import numpy as np
import pandas as pd
import geopandas as gpd
import datetime
import glob
import winsound

from datetime import datetime

# ------------------------------------------------------------------------------
# SETUP
# ------------------------------------------------------------------------------
script_run_on_server = 0



# IMPORT ------------------------------------------------------------------------------

if script_run_on_server == 0:
    wd_path = "C:/Models/OptimalPV_RH"   # path for private computer
    data_path = f'{wd_path}_data'
elif script_run_on_server == 1:
    wd_path = "D:/RaulHochuli_inuse/OptimalPV_RH"
    data_path = f'{wd_path}_data'

# wd_path = 'C:/Models/OptimalPV_RH'
# data_path = f'{wd_path}_data'
os.chdir(wd_path)
os.listdir(data_path)


# exactly 1:1 like JF
url = "https://drive.switch.ch/index.php/s/oSD2BSKcj84YQoL/download?path=%2FLupien_aggregation_20240110&files=agg_solkat_pv_gm_BY_INSTALLATION.csv"
exploitablepv = pd.read_csv(url, sep = ",")    


# drop unnecessary columns
column_names = ["DF_UID", "DF_NUMMER", "DATUM_AENDERUNG", "KLASSE", "FLAECHE", 
                "MSTRAHLUNG", "GSTRAHLUNG", "STROMERTRAG", "xtf_id", 
                "TotalPower", "BeginningOfOperation", "BFS_NUMMER", "year"]
subset_exploitablepv = exploitablepv[column_names]

# keeping only installations of 30 kW or smaller
subset_exploitablepv = subset_exploitablepv.loc[subset_exploitablepv["TotalPower"] <= 30]

# creating column for pv installation size in m2
subset_exploitablepv["pvsize"] = subset_exploitablepv["TotalPower"] / 0.2

# Keeping only years 2018 to 2022
subset_exploitablepv = subset_exploitablepv.loc[(subset_exploitablepv["year"] >= 2018) & (subset_exploitablepv["year"] <= 2022)]

#changes from here ----------------------------------------------------------------------------------------------
subset_exploitablepv["Electricity_Production"] = 0
subset_exploitablepv["Remaining_Capacity"] = subset_exploitablepv["pvsize"]




# just some small things for the loop
subset_exploitablepv = subset_exploitablepv.sort_values(by=["xtf_id", "pvsize", "KLASSE", "MSTRAHLUNG" ], ascending=[True, True, False, False ])
subset_exploitablepv_AFTERLOOP = pd.DataFrame()

counter = 0
total_n_xtf = subset_exploitablepv['xtf_id'].nunique()



for id in subset_exploitablepv['xtf_id'].unique():

    subset_xtf_TF = subset_exploitablepv["xtf_id"] == id
    subset_xtf = subset_exploitablepv.loc[subset_xtf_TF].copy()
    subset_xtf["Electricity_Production"] = subset_xtf["Electricity_Production"].astype(float)


    remaining_size = max(subset_exploitablepv.loc[subset_xtf_TF]["Remaining_Capacity"])

    for n in range(0, subset_xtf_TF.sum()):
        # production = min(subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["FLAECHE"], remaining_size) * subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["MSTRAHLUNG"] 
        # subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["Electricity_Production"] = n #subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["Electricity_Production"] + production
        # remaining_size = remaining_size - min(subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["FLAECHE"], remaining_size )

        # subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["Remaining_Capacity"] = subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["Remaining_Capacity"] - min(subset_exploitablepv.loc[subset_xtf_TF].iloc[n]["FLAECHE"], remaining_size )
        # subset_exploitablepv.loc[subset_xtf_TF][["Electricity_Production", "Remaining_Capacity"]] 
 

        production = min(subset_xtf.loc[subset_xtf.index[n],"FLAECHE"], remaining_size) * subset_xtf.loc[subset_xtf.index[n],"MSTRAHLUNG"]
        subset_xtf.loc[subset_xtf.index[n],"Electricity_Production"] = subset_xtf.loc[subset_xtf.index[n],"Electricity_Production"] + production
        
        remaining_size = remaining_size - min(subset_xtf.loc[subset_xtf.index[n],"FLAECHE"], remaining_size)
        subset_xtf.loc[subset_xtf.index[n],"Remaining_Capacity"] = remaining_size #subset_xtf.loc[subset_xtf.index[n],"Remaining_Capacity"] - min(subset_xtf.loc[subset_xtf.index[n],"FLAECHE"], remaining_size)

        
        subset_xtf[["pvsize", "Electricity_Production", "Remaining_Capacity"]]

    # subset_exploitablepv_AFTERLOOP = subset_exploitablepv_AFTERLOOP.append(subset_xtf)
    subset_exploitablepv_AFTERLOOP = pd.concat([subset_exploitablepv_AFTERLOOP, subset_xtf], ignore_index=True)


    counter = counter + 1
    if counter % 10000 == 0:
        print(f'* xtf_id {id}, installation {counter} of {total_n_xtf} ')


# check if folder exists or create new
if not os.path.exists(f'{data_path}/Lupien_aggregation'):
    os.makedirs(f'{data_path}/Lupien_aggregation')
subset_exploitablepv_AFTERLOOP.to_csv(f'{data_path}/Lupien_aggregation/subset_exploitablepv_afterloop.csv', index=False)
print(f'exported to {data_path}/Lupien_aggregation/subset_exploitablepv.csv')

winsound.Beep(440, 500) # frequency, duration
winsound.Beep(440, 500) # frequency, duration



